html
    head
        meta(charset='utf-8')
        meta(http-equiv='X-UA-Compatible' content='IE=edge,chrome=1')
        title OneID Login
        meta(name='viewport' content='width=device-width,initial-scale=1')
        script(src='https://code.jquery.com/jquery-3.5.1.min.js' integrity='sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=' crossorigin='anonymous')
        script(src='https://cdn.rawgit.com/mgalante/jquery.redirect/master/jquery.redirect.js')
    body
        // Load OneID script
        case env
            when 'prod'
                script#disneyid-script(type='text/javascript' src='https://cdn.registerdisney.go.com/v2/outer/DisneyID.js')
            default
                script#disneyid-script(type='text/javascript' src='https://stg.cdn.registerdisney.go.com/v2/outer/DisneyID.js')

        script(type='text/javascript').        
            var did = DisneyID.get({
                // Put your client ID here.  Append the environment to your client id (-STAGE || -PROD)
                clientId: '!{oneid_id}'
        
                // site hosted using HTTPS
                // Responder page is required.
                ,responderPage: 'didresponder'
                
                // CSS File to override default lightbox styles (HTTPS Only)
                // CSS file must be on a publicly accessible https URL
                ,cssOverride: '!{cssOverride}'
                ,optionalConfigs: !{optionalConfigs}
            });
            
            did.on('login', handleLogin);
            did.on('error', handleError)
            did.on('close', handleClose);
            
            did.init().then(function (data) {
                console.log("Event: init");
                data.loggedIn ? handleLogin(data.guest) : did.launchIdentityFlow();
            });
            // clear listeners so only one fires
            function clearListeners() {
                did.off('login');
                did.off('error')
                did.off('close');
            }
        
            function handleLogin(d) {
                console.log(`Event: login`)
                clearListeners();
                // add swid and token to params (passed in from request)
                var params = {
                    client_id: '!{client_id}',
                    swid: d.token.swid,
                    access_token: d.token.access_token,
                    id_token: d.token.id_token,
                    redirect_uri: '!{redirect_uri}',
                    state: '!{state}',
                    response_type: '!{response_type}',
                }
                $.redirect(`${location.pathname}/create-session`, params, "POST", "_top"); 
            }
        
            function handleError(err) {
                console.log("Event: error");
                console.log("Error:"+JSON.stringify(err,null,4));
                clearListeners();
                var params = {
                    client_id: '!{client_id}',
                    redirect_uri: '!{redirect_uri}',
                    state: '!{state}',
                    error: 'temporarily_unavailable'
                }
                $.redirect(`${location.pathname}/create-session`, params, "POST", "_top"); 
            }
            function handleClose() {
                console.log("Event: close");
                clearListeners();
                var params = {
                    client_id: '!{client_id}',
                    redirect_uri: '!{redirect_uri}',
                    state: '!{state}',
                    error: 'access_denied'
                }
                $.redirect(`${location.pathname}/create-session`, params, "POST", "_top"); 
            }
        